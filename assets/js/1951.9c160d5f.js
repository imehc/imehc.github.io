"use strict";(self.webpackChunkanch=self.webpackChunkanch||[]).push([["1951"],{21522(e,t,i){let s;i.d(t,{initViewer:()=>I});var r=i(38279),o=i(30571),n=i(7487),l=i(22661),a=i(77350),h=i(30673),c=i(24599),u=i(12002),p=i(22831),d=i(65779),m=i(60288),g=i(77329),f=i(10045),w=i(78904),b=i(44454);let v={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:e=>e},y=Math.fround||(s=new Float32Array(1),e=>(s[0]=+e,s[0]));class _{constructor(e){this.options=Object.assign(Object.create(v),e),this.trees=Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){let{log:t,minZoom:i,maxZoom:s}=this.options;t&&console.time("total time");let r=`prepare ${e.length} points`;t&&console.time(r),this.points=e;let o=[];for(let t=0;t<e.length;t++){let i=e[t];if(!i.geometry)continue;let[s,r]=i.geometry.coordinates,n=y(A(s)),l=y(P(r));o.push(n,l,1/0,t,-1,1),this.options.reduce&&o.push(0)}let n=this.trees[s+1]=this._createTree(o);t&&console.timeEnd(r);for(let e=s;e>=i;e--){let i=+Date.now();n=this.trees[e]=this._createTree(this._cluster(n,e)),t&&console.log("z%d: %d clusters in %dms",e,n.numItems,Date.now()-i)}return t&&console.timeEnd("total time"),this}getClusters(e,t){let i=((e[0]+180)%360+360)%360-180,s=Math.max(-90,Math.min(90,e[1])),r=180===e[2]?180:((e[2]+180)%360+360)%360-180,o=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)i=-180,r=180;else if(i>r){let e=this.getClusters([i,s,180,o],t),n=this.getClusters([-180,s,r,o],t);return e.concat(n)}let n=this.trees[this._limitZoom(t)],l=n.range(A(i),P(o),A(r),P(s)),a=n.data,h=[];for(let e of l){let t=this.stride*e;h.push(a[t+5]>1?M(a,t,this.clusterProps):this.points[a[t+3]])}return h}getChildren(e){let t=this._getOriginId(e),i=this._getOriginZoom(e),s="No cluster with the specified id.",r=this.trees[i];if(!r)throw Error(s);let o=r.data;if(t*this.stride>=o.length)throw Error(s);let n=this.options.radius/(this.options.extent*Math.pow(2,i-1)),l=o[t*this.stride],a=o[t*this.stride+1],h=r.within(l,a,n),c=[];for(let t of h){let i=t*this.stride;o[i+4]===e&&c.push(o[i+5]>1?M(o,i,this.clusterProps):this.points[o[i+3]])}if(0===c.length)throw Error(s);return c}getLeaves(e,t,i){t=t||10,i=i||0;let s=[];return this._appendLeaves(s,e,t,i,0),s}getTile(e,t,i){let s=this.trees[this._limitZoom(e)],r=Math.pow(2,e),{extent:o,radius:n}=this.options,l=n/o,a=(i-l)/r,h=(i+1+l)/r,c={features:[]};return this._addTileFeatures(s.range((t-l)/r,a,(t+1+l)/r,h),s.data,t,i,r,c),0===t&&this._addTileFeatures(s.range(1-l/r,a,1,h),s.data,r,i,r,c),t===r-1&&this._addTileFeatures(s.range(0,a,l/r,h),s.data,-1,i,r,c),c.features.length?c:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){let i=this.getChildren(e);if(t++,1!==i.length)break;e=i[0].properties.cluster_id}return t}_appendLeaves(e,t,i,s,r){for(let o of this.getChildren(t)){let t=o.properties;if(t&&t.cluster?r+t.point_count<=s?r+=t.point_count:r=this._appendLeaves(e,t.cluster_id,i,s,r):r<s?r++:e.push(o),e.length===i)break}return r}_createTree(e){let t=new b.A(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let i=0;i<e.length;i+=this.stride)t.add(e[i],e[i+1]);return t.finish(),t.data=e,t}_addTileFeatures(e,t,i,s,r,o){for(let n of e){let e,l,a,h,c=n*this.stride,u=t[c+5]>1;if(u)e=x(t,c,this.clusterProps),l=t[c],a=t[c+1];else{let i=this.points[t[c+3]];e=i.properties;let[s,r]=i.geometry.coordinates;l=A(s),a=P(r)}let p={type:1,geometry:[[Math.round(this.options.extent*(l*r-i)),Math.round(this.options.extent*(a*r-s))]],tags:e};void 0!==(h=u||this.options.generateId?t[c+3]:this.points[t[c+3]].id)&&(p.id=h),o.features.push(p)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))}_cluster(e,t){let{radius:i,extent:s,reduce:r,minPoints:o}=this.options,n=i/(s*Math.pow(2,t)),l=e.data,a=[],h=this.stride;for(let i=0;i<l.length;i+=h){if(l[i+2]<=t)continue;l[i+2]=t;let s=l[i],c=l[i+1],u=e.within(l[i],l[i+1],n),p=l[i+5],d=p;for(let e of u){let i=e*h;l[i+2]>t&&(d+=l[i+5])}if(d>p&&d>=o){let e,o=s*p,n=c*p,m=-1,g=(i/h<<5)+(t+1)+this.points.length;for(let s of u){let a=s*h;if(l[a+2]<=t)continue;l[a+2]=t;let c=l[a+5];o+=l[a]*c,n+=l[a+1]*c,l[a+4]=g,r&&(e||(e=this._map(l,i,!0),m=this.clusterProps.length,this.clusterProps.push(e)),r(e,this._map(l,a)))}l[i+4]=g,a.push(o/d,n/d,1/0,g,-1,d),r&&a.push(m)}else{for(let e=0;e<h;e++)a.push(l[i+e]);if(d>1)for(let e of u){let i=e*h;if(!(l[i+2]<=t)){l[i+2]=t;for(let e=0;e<h;e++)a.push(l[i+e])}}}}return a}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t,i){if(e[t+5]>1){let s=this.clusterProps[e[t+6]];return i?Object.assign({},s):s}let s=this.points[e[t+3]].properties,r=this.options.map(s);return i&&r===s?Object.assign({},r):r}}function M(e,t,i){return{type:"Feature",id:e[t+3],properties:x(e,t,i),geometry:{type:"Point",coordinates:[(e[t]-.5)*360,360*Math.atan(Math.exp((180-360*e[t+1])*Math.PI/180))/Math.PI-90]}}}function x(e,t,i){let s=e[t+5],r=s>=1e4?`${Math.round(s/1e3)}k`:s>=1e3?`${Math.round(s/100)/10}k`:s,o=e[t+6];return Object.assign(-1===o?{}:Object.assign({},i[o]),{cluster:!0,cluster_id:e[t+3],point_count:s,point_count_abbreviated:r})}function A(e){return e/360+.5}function P(e){let t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:i>1?1:i}class C{viewer;option;supercluster;billboards;labels;circleCache={};singlePointImage;lastViewRect="";removePostRenderListener;constructor(e){this.viewer=e.viewer,this.option={pixelRange:40,enable:!0,...e},this.billboards=new a.A({scene:this.viewer.scene}),this.labels=new h.A({scene:this.viewer.scene}),this.viewer.scene.primitives.add(this.billboards),this.viewer.scene.primitives.add(this.labels),this.supercluster=new _({radius:this.option.pixelRange,maxZoom:20}),this.preloadSingleImage(this.option.img),e.results&&this.loadData(e.results),this.bindEvent()}loadData(e){let t=[];Array.isArray(e)?t=e.map(e=>({type:"Feature",properties:{...e},geometry:{type:"Point",coordinates:[e.x,e.y]}})):"FeatureCollection"===e.type&&(t=e.features);try{this.supercluster.load(t)}catch(e){console.error("Supercluster load error",e)}this.lastViewRect="",this.updateView()}bindEvent(){this.removePostRenderListener=this.viewer.scene.postRender.addEventListener(()=>{this.updateView()})}updateView(){if(!this.option.enable)return;let e=this.viewer.camera.computeViewRectangle();if(!(0,c.A)(e))return;let t=`${e.west.toFixed(5)}_${e.south.toFixed(5)}_${e.east.toFixed(5)}_${e.north.toFixed(5)}_${this.viewer.camera.positionCartographic.height.toFixed(0)}`;if(this.lastViewRect===t)return;this.lastViewRect=t;let i=[u.A.toDegrees(e.west),u.A.toDegrees(e.south),u.A.toDegrees(e.east),u.A.toDegrees(e.north)],s=this.viewer.camera.positionCartographic.height,r=Math.floor(this.heightToZoom(s));r=Math.max(0,Math.min(r,20));let o=this.supercluster.getClusters(i,r);for(let e of(this.billboards.removeAll(),this.labels.removeAll(),o)){let[t,i]=e.geometry.coordinates,s=p.A.fromDegrees(t,i),r=e.properties?.cluster,o=e.properties?e.properties.point_count:1;if(r){let e=this.option.colorItems[0];for(let t=this.option.colorItems.length-1;t>=0;t--)if(o>=this.option.colorItems[t].num){e=this.option.colorItems[t];break}this.billboards.add({position:s,image:this.getCircleImage(e.size,e.color),width:e.size,height:e.size,verticalOrigin:d.A.CENTER,eyeOffset:new p.A(0,0,0)}),this.labels.add({position:s,text:String(o),font:'bold 16px "Microsoft YaHei", sans-serif',style:m.A.FILL,fillColor:g.A.WHITE,outlineColor:g.A.BLACK,outlineWidth:2,verticalOrigin:d.A.CENTER,horizontalOrigin:f.A.CENTER,pixelOffset:new w.A(0,-1),eyeOffset:new p.A(0,0,-5),disableDepthTestDistance:1/0,scale:1})}else{let e=this.singlePointImage||this.option.img;this.billboards.add({position:s,image:e,verticalOrigin:d.A.BOTTOM,disableDepthTestDistance:1/0})}}}getCircleImage(e,t){let i=`${e}_${t}`;if(this.circleCache[i])return this.circleCache[i];let s=document.createElement("canvas");s.width=e,s.height=e;let r=s.getContext("2d");if(!r)return"";r.beginPath(),r.arc(e/2,e/2,e/2,0,2*Math.PI,!0),r.fillStyle=t,r.fill(),r.closePath();let o=s.toDataURL();return this.circleCache[i]=o,o}heightToZoom(e){return Math.round(-40467.74+80955.31/(1+(e/91610.74)**709672e-10))}updateData(e){this.loadData(e)}remove(){this.removePostRenderListener&&(this.removePostRenderListener(),this.removePostRenderListener=void 0),this.viewer&&!this.viewer.isDestroyed()&&this.viewer.scene&&(this.billboards&&this.viewer.scene.primitives.remove(this.billboards),this.labels&&this.viewer.scene.primitives.remove(this.labels)),this.billboards=null,this.labels=null,this.circleCache={}}preloadSingleImage(e){let t=new Image;t.src=e,t.onload=()=>{this.singlePointImage=t,this.lastViewRect="",this.updateView()},t.onerror=()=>{console.error("\u5355\u4E2A\u70B9\u56FE\u6807\u52A0\u8F7D\u5931\u8D25:",e)}}}function I(e){let t=new r.A(e,{baseLayerPicker:!1,animation:!1,timeline:!1,fullscreenButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,navigationHelpButton:!1});t.scene.debugShowFramesPerSecond=!0,t.imageryLayers.remove(t.imageryLayers.get(0)),t.scene.terrainProvider=new o.A({});let i=new n.A({url:"//data.mars3d.cn/tile/img/{z}/{x}/{y}.jpg"});t.imageryLayers.addImageryProvider(i),new l.A(t,{enableCompass:!0,enableZoomControls:!0});let s=new C({viewer:t,results:function(e,t,i,s,r,o){if("geojson"===o){let e={type:"FeatureCollection",features:[]};for(let t=0;t<1e4;t++){let t={type:"Feature",properties:{value:parseInt(`${1e7*Math.random()}`,10)},geometry:{type:"Point",coordinates:[30*Math.random()+-120,15*Math.random()+25]}};e.features.push(t)}return e}{let e=[];for(let t=0;t<1e4;t++){let t={x:30*Math.random()+-120,y:15*Math.random()+25};e.push(t)}return e}}(-120,-90,25,40,1e4,"geojson"),pixelRange:80,colorItems:[{num:1,size:30,color:"#1c86d1cc"},{num:50,size:32,color:"#67c23acc"},{num:100,size:34,color:"#f56c6ccc"},{num:200,size:36,color:"#e6a23ccc"}],img:"/cesium/07/marker6.png"});return{viewer:t,cluster:s}}}}]);