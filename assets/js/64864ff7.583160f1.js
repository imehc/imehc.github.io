"use strict";(self.webpackChunkanch=self.webpackChunkanch||[]).push([["5993"],{15279(e,t,r){r.r(t),r.d(t,{metadata:()=>a,default:()=>L,frontMatter:()=>q,contentTitle:()=>E,toc:()=>H,assets:()=>V});var a=JSON.parse('{"id":"web/three/advanced/fps-octree","title":"FPS \u516B\u53C9\u6811","description":"\u6838\u5FC3\u6982\u5FF5","source":"@site/docs/web/three/advanced/07-fps-octree.mdx","sourceDirName":"web/three/advanced","slug":"/web/three/advanced/fps-octree","permalink":"/chiyu/web/three/advanced/fps-octree","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"Javascript","permalink":"/chiyu/tags/javascript"}],"version":"current","lastUpdatedBy":"imehc","lastUpdatedAt":1768181947000,"sidebarPosition":7,"frontMatter":{"sidebar_position":7,"title":"FPS \u516B\u53C9\u6811","tags":["Javascript"]},"sidebar":"webSidebar","previous":{"title":"\u5C42\u6B21\u7ED3\u6784","permalink":"/chiyu/web/three/advanced/hierarchy"},"next":{"title":"\u65E0\u9650\u6EDA\u52A8","permalink":"/chiyu/web/three/advanced/infinite-scroll"}}'),l=r(35656),s=r(75395),n=r(1340),c=r(50642),o=r(6124),d=r(60140),i=r(82044),u=r(24809),p=r(57140);let h=({radius:e})=>(0,l.jsxs)("mesh",{castShadow:!0,children:[(0,l.jsx)("sphereGeometry",{args:[e]}),(0,l.jsx)("meshStandardMaterial",{})]});var m=r(67199);let y=[...Array(100)].map(()=>({position:[50*Math.random()-25,20,50*Math.random()-25]})),f=new m.Pq0,w=new m.Pq0,b=new m.Pq0;var S=r(45225),v=r(67374);let g=({ballCount:e,octree:t,colliders:r})=>{let a,l=(0,p.useRef)(!1),s=(0,p.useMemo)(()=>new m.Pq0,[]),n=(0,p.useMemo)(()=>new m.Pq0,[]),c=(0,p.useMemo)(()=>new v.w(new m.Pq0(0,10,0),new m.Pq0(0,11,0),.5),[]),{camera:o}=(0,S.C)(),d=0,i=(0,p.useCallback)((t,a,l,s,n)=>{let{sphere:c,velocity:o}=r[n%e];t.getWorldDirection(l),c?.center.copy(a.end).addScaledVector(l,1.5*a.radius),o.copy(l).multiplyScalar(50),o.addScaledVector(s,2)},[e,r]),u=(0,p.useCallback)(()=>{i(o,c,n,s,d++)},[o,c,d,n,s,i]);(0,p.useEffect)(()=>(document.addEventListener("pointerdown",u),()=>{document.removeEventListener("pointerdown",u)}),[u]),(0,p.useEffect)(()=>{r[e]={capsule:c,velocity:s}},[r,e,c,s]);let h=(a=(0,p.useRef)({}),(0,p.useEffect)(()=>{let e=e=>{a.current[e.code]="keydown"===e.type};return document.addEventListener("keydown",e),document.addEventListener("keyup",e),()=>{document.removeEventListener("keydown",e),document.removeEventListener("keyup",e)}}),a.current),y=(0,p.useCallback)((e,t)=>(e.getWorldDirection(t),t.y=0,t.normalize(),t),[]),f=(0,p.useCallback)(()=>(o.getWorldDirection(n),n.y=0,n.normalize(),n.cross(o.up),n),[o,n]),w=(0,p.useCallback)((e,t,r,a,l)=>{let s=t*(a?25:8);h.KeyA&&r.add(f(e,l).multiplyScalar(-s)),h.KeyD&&r.add(f(e,l).multiplyScalar(s)),h.KeyW&&r.add(y(e,l).multiplyScalar(s)),h.KeyS&&r.add(y(e,l).multiplyScalar(-s)),a&&h.Space&&(r.y=15)},[y,f,h]),b=(0,p.useCallback)((e,t,r)=>{let a=t.capsuleIntersect(e),l=!1;return a&&((l=a.normal.y>0)||r.addScaledVector(a.normal,-a.normal.dot(r)),e.translate(a.normal.multiplyScalar(a.depth))),l},[]),g=(0,p.useCallback)((e,t,r,a,l,s)=>{let n=Math.exp(-4*t)-1;s||(l.y-=30*t,n*=.1),l.addScaledVector(l,n);let c=l.clone().multiplyScalar(t);return a.translate(c),s=b(a,r,l),e.position.copy(a.end),s},[b]),x=(0,p.useCallback)((e,t,r)=>{e.position.y<=-100&&(r.set(0,0,0),t.start.set(0,10,0),t.end.set(0,11,0),e.position.copy(t.end),e.rotation.set(0,0,0))},[]);return(0,S.D)(({camera:e},r)=>{w(e,r,s,l.current,n);let a=Math.min(.05,r)/5;for(let r=0;r<5;r++)l.current=g(e,a,t,c,s,l.current);x(e,c,s)}),null},x=({id:e,radius:t,octree:r,position:a,colliders:s,checkSphereCollisions:n,children:c})=>{let o=(0,p.useRef)(null),d=(0,p.useMemo)(()=>new m.iyt(new m.Pq0(...a),t),[a,t]),i=(0,p.useMemo)(()=>new m.Pq0,[]);(0,p.useEffect)(()=>{console.log("adding reference to this sphere collider"),s[e]={sphere:d,velocity:i}},[s,e,d,i]);let u=(0,p.useCallback)((e,t,r,a)=>{r.center.addScaledVector(a,e);let l=t.sphereIntersect(r);if(l){let e=-l.normal.dot(a);a.addScaledVector(l.normal,1.5*e),r.center.add(l.normal.multiplyScalar(l.depth))}else a.y-=30*e;let s=Math.exp(-1.5*e)-1;a.addScaledVector(a,s),n(r,a),o.current&&o.current.position.copy(r.center)},[n]);return(0,S.D)((e,t)=>{let a=Math.min(.05,t)/5;for(let e=0;e<5;e++)u(a,r,d,i)}),(0,l.jsx)("group",{ref:o,children:c})};var j=r(29299),k=r(22374),C=r(8684);let M=()=>{let{nodes:e,scene:t}=(0,u.p)("/models/scene-transformed.glb"),r=(0,p.useMemo)(()=>(console.log("new Octree"),new j.x().fromGraphNode(t)),[t]);(e=>{let{scene:t}=(0,S.C)();(0,p.useEffect)(()=>{console.log("new OctreeHelper");let r=new C.J(e,"hotpink");return r.name="octreeHelper",t.add(r),()=>{console.log("removing OctreeHelper"),t.remove(r)}},[e,t]),(0,k._5)("Octree Helper \u516B\u53C9\u6811",{visible:{value:!1,onChange:e=>{t.getObjectByName("octreeHelper").visible=e,document.getElementById("Octree Helper.visible")&&document.getElementById("Octree Helper.visible").blur()}}})})(r);let a=(0,p.useRef)([]),s=(0,p.useCallback)((e,t)=>{for(let r=0,l=a.current.length;r<l;r++){let l=a.current[r];if(l.sphere){let r=e.center.distanceToSquared(l.sphere.center),a=e.radius+l.sphere.radius;if(r<a*a){let s=f.subVectors(e.center,l.sphere.center).normalize(),n=w.copy(s).multiplyScalar(s.dot(t)),c=b.copy(s).multiplyScalar(s.dot(l.velocity));t.add(c).sub(n),l.velocity.add(n).sub(c);let o=(a-Math.sqrt(r))/2;e.center.addScaledVector(s,o),l.sphere.center.addScaledVector(s,-o)}}else if(l.capsule){let r=f.addVectors(l.capsule.start,l.capsule.end).multiplyScalar(.5),a=e.radius+l.capsule.radius,s=a*a;for(let n of[l.capsule.start,l.capsule.end,r]){let r=n.distanceToSquared(e.center);if(r<s){let s=f.subVectors(n,e.center).normalize(),c=w.copy(s).multiplyScalar(s.dot(l.velocity)),o=b.copy(s).multiplyScalar(s.dot(t));l.velocity.add(o).sub(c),t.add(c).sub(o);let d=(a-Math.sqrt(r))/2;e.center.addScaledVector(s,-d)}}}}},[]);return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("group",{dispose:null,children:(0,l.jsx)("mesh",{castShadow:!0,receiveShadow:!0,geometry:e.Suzanne007.geometry,material:e.Suzanne007.material,position:[1.74,1.04,24.97]})}),y.map(({position:e},t)=>(0,l.jsx)(x,{id:t,radius:.2,octree:r,position:e,colliders:a.current,checkSphereCollisions:s,children:(0,l.jsx)(h,{radius:.2})},t)),(0,l.jsx)(g,{ballCount:100,octree:r,colliders:a.current})]})},P=()=>(0,l.jsx)(i.A,{children:(0,l.jsxs)(d.Hl,{shadows:!0,children:[(0,l.jsx)("directionalLight",{intensity:1,castShadow:!0,"shadow-bias":-15e-5,"shadow-radius":4,"shadow-blur":10,"shadow-mapSize":[2048,2048],position:[85,80,70],"shadow-camera-left":-30,"shadow-camera-right":30,"shadow-camera-top":30,"shadow-camera-bottom":-30}),(0,l.jsx)(n.OH,{files:"/imgs/rustig_koppie_puresky_1k.hdr",background:!0}),(0,l.jsx)(M,{}),(0,l.jsx)(c.Z,{}),(0,l.jsx)(o.U,{})]})}),q={sidebar_position:7,title:"FPS \u516B\u53C9\u6811",tags:["Javascript"]},E="FPS \u516B\u53C9\u6811",V={},H=[{value:"\u6838\u5FC3\u6982\u5FF5",id:"\u6838\u5FC3\u6982\u5FF5",level:2}];function O(e){let t={h1:"h1",h2:"h2",header:"header",li:"li",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(t.header,{children:(0,l.jsx)(t.h1,{id:"fps-\u516B\u53C9\u6811",children:"FPS \u516B\u53C9\u6811"})}),"\n",(0,l.jsx)(P,{}),"\n",(0,l.jsx)(t.h2,{id:"\u6838\u5FC3\u6982\u5FF5",children:"\u6838\u5FC3\u6982\u5FF5"}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"PointerLockControls"}),": \u9501\u5B9A\u9F20\u6807\u6307\u9488\u5B9E\u73B0\u7B2C\u4E00\u4EBA\u79F0\u89C6\u89D2"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u516B\u53C9\u6811\u78B0\u649E\u68C0\u6D4B"}),": \u9AD8\u6548\u7684\u7A7A\u95F4\u5206\u5272\u7B97\u6CD5\u7528\u4E8E\u78B0\u649E\u68C0\u6D4B"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u80F6\u56CA\u4F53\u78B0\u649E\u5668"}),": \u7528\u4E8E\u8868\u793A\u73A9\u5BB6\u7684\u78B0\u649E\u4F53\u79EF"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u7269\u7406\u6A21\u62DF"}),": \u91CD\u529B\u3001\u8DF3\u8DC3\u3001\u79FB\u52A8\u7684\u7269\u7406\u8BA1\u7B97"]}),"\n"]})]})}function L(e={}){let{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,l.jsx)(t,{...e,children:(0,l.jsx)(O,{...e})}):O(e)}}}]);