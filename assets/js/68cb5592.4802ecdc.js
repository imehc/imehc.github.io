"use strict";(self.webpackChunkanch=self.webpackChunkanch||[]).push([["5278"],{55893(e,t,r){r.r(t),r.d(t,{metadata:()=>n,default:()=>S,frontMatter:()=>M,contentTitle:()=>j,toc:()=>P,assets:()=>w});var n=JSON.parse('{"id":"web/three/advanced/photogrammetry","title":"\u6444\u5F71\u6D4B\u91CF","description":"\u6838\u5FC3\u6982\u5FF5","source":"@site/docs/web/three/advanced/15-photogrammetry.mdx","sourceDirName":"web/three/advanced","slug":"/web/three/advanced/photogrammetry","permalink":"/web/three/advanced/photogrammetry","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"Javascript","permalink":"/tags/javascript"}],"version":"current","lastUpdatedBy":"dependabot[bot]","lastUpdatedAt":1769646500000,"sidebarPosition":15,"frontMatter":{"sidebar_position":15,"title":"\u6444\u5F71\u6D4B\u91CF","tags":["Javascript"]},"sidebar":"webSidebar","previous":{"title":"\u5730\u7403 Map","permalink":"/web/three/advanced/earth-map"},"next":{"title":"\u52A0\u8F7D\u672C\u5730\u6A21\u578B","permalink":"/web/three/advanced/preview-model"}}'),i=r(35656),s=r(86145),a=r(12730),l=r(74915),o=r(82390),c=r(30119),d=r(46571),u=r(54600),h=r(14062),m=r(57140),f=r(82044),p=r(84639);function x({controls:e}){let{nodes:t,materials:r}=(0,p.p)("/models/scan-transformed.glb");return(0,i.jsxs)("group",{dispose:null,children:[(0,i.jsx)("mesh",{geometry:t.Mesh_0.geometry,material:r.material_0}),(0,i.jsxs)("mesh",{position:[0,-.25,-.6],"rotation-y":-Math.PI/64,onDoubleClick:({point:t})=>{new h.K(e.current.target,v).to({x:t.x,y:t.y,z:t.z},500).easing(h.GS.Cubic.Out).start()},children:[(0,i.jsx)("boxGeometry",{args:[30,3,.1]}),(0,i.jsx)("meshBasicMaterial",{wireframe:!0,visible:!1})]})]})}p.p.preload("/models/scan-transformed.glb");let v=new h.YJ;function g(){let{progress:e}=(0,o.p)();return(0,i.jsxs)(c.E,{center:!0,children:[e," % loaded"]})}function y(){return(0,u.D)(()=>{v.update()}),null}let b=()=>{let e=(0,m.useRef)(null);return(0,i.jsxs)(f.A,{children:[(0,i.jsx)(d.Hl,{shadows:!0,camera:{position:[4,0,3]},children:(0,i.jsxs)(m.Suspense,{fallback:(0,i.jsx)(g,{}),children:[(0,i.jsx)(a.OH,{preset:"forest"}),(0,i.jsx)(l.N,{ref:e,target:[4,0,0]}),(0,i.jsx)(x,{controls:e}),(0,i.jsx)(y,{})]})}),(0,i.jsx)("div",{className:"absolute left-2 top-2",children:"Doubleclick to change OrbitControls target"})]})},M={sidebar_position:15,title:"\u6444\u5F71\u6D4B\u91CF",tags:["Javascript"]},j="\u6444\u5F71\u6D4B\u91CF",w={},P=[{value:"\u6838\u5FC3\u6982\u5FF5",id:"\u6838\u5FC3\u6982\u5FF5",level:2}];function E(e){let t={h1:"h1",h2:"h2",header:"header",li:"li",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"\u6444\u5F71\u6D4B\u91CF",children:"\u6444\u5F71\u6D4B\u91CF"})}),"\n",(0,i.jsx)(b,{}),"\n",(0,i.jsx)(t.h2,{id:"\u6838\u5FC3\u6982\u5FF5",children:"\u6838\u5FC3\u6982\u5FF5"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"\u6444\u5F71\u6D4B\u91CF"}),": \u4ECE\u7167\u7247\u91CD\u5EFA\u771F\u5B9E\u4E16\u754C\u7684 3D \u6A21\u578B"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"\u6027\u80FD\u4F18\u5316"}),": \u4F7F\u7528\u7B80\u5316\u78B0\u649E\u4F53\u5904\u7406\u9AD8\u591A\u8FB9\u5F62\u6A21\u578B"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"\u5C04\u7EBF\u68C0\u6D4B"}),": \u53CC\u51FB\u4E8B\u4EF6\u7684 3D \u5750\u6807\u83B7\u53D6"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"\u76F8\u673A\u52A8\u753B"}),": \u5E73\u6ED1\u79FB\u52A8\u76F8\u673A\u76EE\u6807\u70B9"]}),"\n"]})]})}function S(e={}){let{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(E,{...e})}):E(e)}},82390(e,t,r){r.d(t,{p:()=>a}),r(57140);var n=r(67199),i=r(3355);let s=0,a=(0,i.v)(e=>(n.h_9.onStart=(t,r,n)=>{e({active:!0,item:t,loaded:r,total:n,progress:(r-s)/(n-s)*100})},n.h_9.onLoad=()=>{e({active:!1})},n.h_9.onError=t=>e(e=>({errors:[...e.errors,t]})),n.h_9.onProgress=(t,r,n)=>{r===n&&(s=n),e({active:!0,item:t,loaded:r,total:n,progress:(r-s)/(n-s)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0}))},30119(e,t,r){let n,i;r.d(t,{E:()=>y});var s=r(44320),a=r(57140),l=r(84668),o=r(67199),c=r(54600);let d=new o.Pq0,u=new o.Pq0,h=new o.Pq0,m=new o.I9Y;function f(e,t,r){let n=d.setFromMatrixPosition(e.matrixWorld);n.project(t);let i=r.width/2,s=r.height/2;return[n.x*i+i,-(n.y*s)+s]}let p=e=>1e-10>Math.abs(e)?0:e;function x(e,t,r=""){let n="matrix3d(";for(let r=0;16!==r;r++)n+=p(t[r]*e.elements[r])+(15!==r?",":")");return r+n}let v=(n=[1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1],e=>x(e,n)),g=(i=e=>[1/e,1/e,1/e,1,-1/e,-1/e,-1/e,-1,1/e,1/e,1/e,1,1,1,1,1],(e,t)=>x(e,i(t),"translate(-50%,-50%)")),y=a.forwardRef(({children:e,eps:t=.001,style:r,className:n,prepend:i,center:x,fullscreen:y,portal:b,distanceFactor:M,sprite:j=!1,transform:w=!1,occlude:P,onOcclude:E,castShadow:S,receiveShadow:W,material:k,geometry:$,zIndexRange:R=[0x1000037,0],calculatePosition:z=f,as:C="div",wrapperClass:F,pointerEvents:A="auto",...I},T)=>{let{gl:_,camera:D,scene:N,size:H,raycaster:q,events:O,viewport:J}=(0,c.C)(),[L]=a.useState(()=>document.createElement(C)),U=a.useRef(null),B=a.useRef(null),G=a.useRef(0),V=a.useRef([0,0]),Y=a.useRef(null),K=a.useRef(null),Z=(null==b?void 0:b.current)||O.connected||_.domElement.parentNode,Q=a.useRef(null),X=a.useRef(!1),ee=a.useMemo(()=>{var e;return P&&"blending"!==P||Array.isArray(P)&&P.length&&(e=P[0])&&"object"==typeof e&&"current"in e},[P]);a.useLayoutEffect(()=>{let e=_.domElement;P&&"blending"===P?(e.style.zIndex=`${Math.floor(R[0]/2)}`,e.style.position="absolute",e.style.pointerEvents="none"):(e.style.zIndex=null,e.style.position=null,e.style.pointerEvents=null)},[P]),a.useLayoutEffect(()=>{if(B.current){let e=U.current=l.createRoot(L);if(N.updateMatrixWorld(),w)L.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{let e=z(B.current,D,H);L.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${e[0]}px,${e[1]}px,0);transform-origin:0 0;`}return Z&&(i?Z.prepend(L):Z.appendChild(L)),()=>{Z&&Z.removeChild(L),e.unmount()}}},[Z,w]),a.useLayoutEffect(()=>{F&&(L.className=F)},[F]);let et=a.useMemo(()=>w?{position:"absolute",top:0,left:0,width:H.width,height:H.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:x?"translate3d(-50%,-50%,0)":"none",...y&&{top:-H.height/2,left:-H.width/2,width:H.width,height:H.height},...r},[r,x,y,H,w]),er=a.useMemo(()=>({position:"absolute",pointerEvents:A}),[A]);a.useLayoutEffect(()=>{var t,i;X.current=!1,w?null==(t=U.current)||t.render(a.createElement("div",{ref:Y,style:et},a.createElement("div",{ref:K,style:er},a.createElement("div",{ref:T,className:n,style:r,children:e})))):null==(i=U.current)||i.render(a.createElement("div",{ref:T,style:et,className:n,children:e}))});let en=a.useRef(!0);(0,c.D)(e=>{if(B.current){D.updateMatrixWorld(),B.current.updateWorldMatrix(!0,!1);let e=w?V.current:z(B.current,D,H);if(w||Math.abs(G.current-D.zoom)>t||Math.abs(V.current[0]-e[0])>t||Math.abs(V.current[1]-e[1])>t){var r;let t,n,i,s,a=(r=B.current,t=d.setFromMatrixPosition(r.matrixWorld),n=u.setFromMatrixPosition(D.matrixWorld),i=t.sub(n),s=D.getWorldDirection(h),i.angleTo(s)>Math.PI/2),l=!1;ee&&(Array.isArray(P)?l=P.map(e=>e.current):"blending"!==P&&(l=[N]));let c=en.current;l?en.current=function(e,t,r,n){let i=d.setFromMatrixPosition(e.matrixWorld),s=i.clone();s.project(t),m.set(s.x,s.y),r.setFromCamera(m,t);let a=r.intersectObjects(n,!0);if(a.length){let e=a[0].distance;return i.distanceTo(r.ray.origin)<e}return!0}(B.current,D,q,l)&&!a:en.current=!a,c!==en.current&&(E?E(!en.current):L.style.display=en.current?"block":"none");let f=Math.floor(R[0]/2),x=P?ee?[R[0],f]:[f-1,0]:R;if(L.style.zIndex=`${function(e,t,r){if(t instanceof o.ubm||t instanceof o.qUd){let n=d.setFromMatrixPosition(e.matrixWorld),i=u.setFromMatrixPosition(t.matrixWorld),s=n.distanceTo(i),a=(r[1]-r[0])/(t.far-t.near),l=r[1]-a*t.far;return Math.round(a*s+l)}}(B.current,D,x)}`,w){let[e,t]=[H.width/2,H.height/2],r=D.projectionMatrix.elements[5]*t,{isOrthographicCamera:n,top:i,left:s,bottom:a,right:l}=D,o=v(D.matrixWorldInverse),c=n?`scale(${r})translate(${p(-(l+s)/2)}px,${p((i+a)/2)}px)`:`translateZ(${r}px)`,d=B.current.matrixWorld;j&&((d=D.matrixWorldInverse.clone().transpose().copyPosition(d).scale(B.current.scale)).elements[3]=d.elements[7]=d.elements[11]=0,d.elements[15]=1),L.style.width=H.width+"px",L.style.height=H.height+"px",L.style.perspective=n?"":`${r}px`,Y.current&&K.current&&(Y.current.style.transform=`${c}${o}translate(${e}px,${t}px)`,K.current.style.transform=g(d,1/((M||10)/400)))}else{let t=void 0===M?1:function(e,t){if(t instanceof o.qUd)return t.zoom;if(!(t instanceof o.ubm))return 1;{let r=d.setFromMatrixPosition(e.matrixWorld),n=u.setFromMatrixPosition(t.matrixWorld);return 1/(2*Math.tan(t.fov*Math.PI/180/2)*r.distanceTo(n))}}(B.current,D)*M;L.style.transform=`translate3d(${e[0]}px,${e[1]}px,0) scale(${t})`}V.current=e,G.current=D.zoom}}if(!ee&&Q.current&&!X.current)if(w){if(Y.current){let e=Y.current.children[0];if(null!=e&&e.clientWidth&&null!=e&&e.clientHeight){let{isOrthographicCamera:t}=D;if(t||$)I.scale&&(Array.isArray(I.scale)?I.scale instanceof o.Pq0?Q.current.scale.copy(I.scale.clone().divideScalar(1)):Q.current.scale.set(1/I.scale[0],1/I.scale[1],1/I.scale[2]):Q.current.scale.setScalar(1/I.scale));else{let t=(M||10)/400,r=e.clientWidth*t,n=e.clientHeight*t;Q.current.scale.set(r,n,1)}X.current=!0}}}else{let t=L.children[0];if(null!=t&&t.clientWidth&&null!=t&&t.clientHeight){let e=1/J.factor,r=t.clientWidth*e,n=t.clientHeight*e;Q.current.scale.set(r,n,1),X.current=!0}Q.current.lookAt(e.camera.position)}});let ei=a.useMemo(()=>({vertexShader:w?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[w]);return a.createElement("group",(0,s.A)({},I,{ref:B}),P&&!ee&&a.createElement("mesh",{castShadow:S,receiveShadow:W,ref:Q},$||a.createElement("planeGeometry",null),k||a.createElement("shaderMaterial",{side:o.$EB,vertexShader:ei.vertexShader,fragmentShader:ei.fragmentShader})))})},3355(e,t,r){r.d(t,{v:()=>a});var n=r(57140),i=r(13347);let s=e=>{let t=(0,i.y)(e),r=e=>(function(e,t=e=>e){let r=n.useSyncExternalStore(e.subscribe,n.useCallback(()=>t(e.getState()),[e,t]),n.useCallback(()=>t(e.getInitialState()),[e,t]));return n.useDebugValue(r),r})(t,e);return Object.assign(r,t),r},a=e=>e?s(e):s}}]);