"use strict";(self.webpackChunkanch=self.webpackChunkanch||[]).push([["6946"],{13753(e,t,i){i.d(t,{initViewer:()=>A});var n=i(38279),s=i(30571),a=i(7487),l=i(81509),o=i(53526),r=i(22831),d=i(12002),h=i(32777),c=i(16264),u=i(22661),v=i(97168),m=i(95446),g=i(77329),y=i(78904),p=i(9686),b=i(26631),w=i(94515);let L=class{viewer;startPoint;endPoint;visibleColor;invisibleColor;lineWidth;segments;startEntity=null;endEntity=null;visibleLineEntity=null;invisibleLineEntity=null;constructor(e){this.viewer=e.viewer,this.startPoint=e.startPoint,this.endPoint=e.endPoint,this.visibleColor=e.visibleColor||g.A.GREEN,this.invisibleColor=e.invisibleColor||g.A.RED,this.lineWidth=e.lineWidth??3,this.segments=e.segments??100,this.createPoints()}createPoints(){this.startEntity=this.viewer.entities.add({name:"\u89C2\u6D4B\u70B9",position:this.startPoint,point:{pixelSize:8,color:g.A.RED,outlineColor:g.A.WHITE,outlineWidth:2},label:{text:"\u89C2\u6D4B\u70B9",font:"14pt sans-serif",outlineWidth:2,outlineColor:g.A.BLACK,fillColor:g.A.WHITE,pixelOffset:new y.A(0,-10)}}),this.endEntity=this.viewer.entities.add({name:"\u76EE\u7684\u70B9",position:this.endPoint,point:{pixelSize:8,color:g.A.BLUE,outlineColor:g.A.WHITE,outlineWidth:2},label:{text:"\u76EE\u7684\u70B9",font:"14pt sans-serif",outlineWidth:2,outlineColor:g.A.BLACK,fillColor:g.A.WHITE,pixelOffset:new y.A(0,-10)}})}analyze(){let e=this.sightline(this.startPoint,this.endPoint),t=this.calculateSpatialDistance(this.startPoint,this.endPoint),i=!1,n=0;return 0===e.x&&0===e.y&&0===e.z?(i=!0,n=t,this.drawVisibleLine(this.startPoint,this.endPoint)):(i=!1,n=this.calculateSpatialDistance(this.startPoint,e),this.drawInvisibleLine(this.startPoint,e,this.endPoint)),{visible:i,barrierPoint:e,visibleDistance:n,totalDistance:t}}sightline(e,t){let i=r.A.ZERO.clone(),n=this.convertCartesian3ToCartesian2(e),s=this.convertCartesian3ToCartesian2(t);if(!n||!s)return i;let a=this.calculateSpatialDistance(e,t),l=this.calculateWindowDistance(n,s),o=a/this.segments,d=l/this.segments;for(let a=1;a<this.segments;a++){let l=this.findWindowPositionByPixelInterval(n,s,d*a),r=this.findCartesian3ByDistance(e,t,o*a),c=this.pickCartesian(l);if(!c||!c.cartesian)continue;let u=h.A.fromCartesian(r);if(h.A.fromCartesian(c.cartesian).height>u.height){i=r;break}}return i}drawVisibleLine(e,t){this.clearLines(),this.visibleLineEntity=this.viewer.entities.add({polyline:{positions:[e,t],width:this.lineWidth,material:this.visibleColor,clampToGround:!1}})}drawInvisibleLine(e,t,i){this.clearLines(),this.visibleLineEntity=this.viewer.entities.add({polyline:{positions:[e,t],width:this.lineWidth,material:this.visibleColor,clampToGround:!1}}),this.invisibleLineEntity=this.viewer.entities.add({polyline:{positions:[t,i],width:this.lineWidth,material:this.invisibleColor,clampToGround:!1}})}clearLines(){this.visibleLineEntity&&(this.viewer.entities.remove(this.visibleLineEntity),this.visibleLineEntity=null),this.invisibleLineEntity&&(this.viewer.entities.remove(this.invisibleLineEntity),this.invisibleLineEntity=null)}convertCartesian3ToCartesian2(e){return p.A.worldToWindowCoordinates(this.viewer.scene,e)}calculateSpatialDistance(e,t){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2+(t.z-e.z)**2)}calculateWindowDistance(e,t){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}findWindowPositionByPixelInterval(e,t,i){let n=new y.A(0,0),s=Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2);if(s<i)return n;let a=i/s*(t.x-e.x)+e.x,l=i/s*(t.y-e.y)+e.y;return n.x=a,n.y=l,n}findCartesian3ByDistance(e,t,i){let n=new r.A(0,0,0),s=Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2+(t.z-e.z)**2);if(s<i)return n;let a=i/s*(t.x-e.x)+e.x,l=i/s*(t.y-e.y)+e.y,o=i/s*(t.z-e.z)+e.z;return n.x=a,n.y=l,n.z=o,n}pickCartesian(e){let t=this.viewer.scene.pickPosition(e),i=this.viewer.camera.getPickRay(e);if(!i)return null;let n=this.viewer.scene.globe.pick(i,this.viewer.scene);if(!t&&!n)return null;let s={cartesian:t||n,CartesianModel:t,cartesianTerrain:n,windowCoordinates:e.clone(),altitudeMode:b.Ay.NONE};return t&&n&&(s.altitudeMode=t.z.toFixed(0)!==n.z.toFixed(0)?b.Ay.NONE:b.Ay.CLAMP_TO_GROUND),s}setStartPoint(e){this.startPoint=e,this.startEntity?.position&&(this.startEntity.position=new w.A(e)),this.clearLines()}setEndPoint(e){this.endPoint=e,this.endEntity?.position&&(this.endEntity.position=new w.A(e)),this.clearLines()}getStartPoint(){return this.startPoint}getEndPoint(){return this.endPoint}clear(){this.clearLines(),this.startEntity&&(this.viewer.entities.remove(this.startEntity),this.startEntity=null),this.endEntity&&(this.viewer.entities.remove(this.endEntity),this.endEntity=null)}};function A(e){let t=new n.A(e,{baseLayerPicker:!1,animation:!1,timeline:!1,fullscreenButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,navigationHelpButton:!1});t.scene.debugShowFramesPerSecond=!0,t.imageryLayers.remove(t.imageryLayers.get(0)),t.scene.terrainProvider=new s.A({}),t.scene.globe.depthTestAgainstTerrain=!0;let i=new a.A({url:"//data.mars3d.cn/tile/img/{z}/{x}/{y}.jpg"});t.imageryLayers.addImageryProvider(i),l.A.fromUrl("//data.mars3d.cn/terrain",{requestWaterMask:!0,requestVertexNormals:!0}).then(e=>{t.scene.terrainProvider=e,console.log("\u5730\u5F62\u52A0\u8F7D\u6210\u529F")}).catch(e=>{console.error("\u52A0\u8F7D\u5730\u5F62\u5931\u8D25:",e)}),t.cesiumWidget.screenSpaceEventHandler.removeInputAction(o.A.LEFT_CLICK),t.cesiumWidget.screenSpaceEventHandler.removeInputAction(o.A.LEFT_DOUBLE_CLICK),new u.A(t,{enableCompass:!0,enableZoomControls:!0}),t.camera.setView({destination:r.A.fromDegrees(98.685331,27.780325,7318.6),orientation:{heading:d.A.toRadians(73),pitch:d.A.toRadians(-52.2),roll:0}});let g=new v.GUI;g.domElement.style.position="fixed",g.domElement.style.top="50%",g.domElement.style.transform="translateY(-50%)",g.domElement.style.left="0";let y=null,p={startLng:98.71707797694049,startLat:27.77729970463954,startHeight:2800,endLng:98.71707797694049,endLat:27.80729970463954,endHeight:3500,visible:!1,visibleDistance:0,totalDistance:0,\u521B\u5EFA\u5206\u6790:()=>{y&&y.clear(),y=new L({viewer:t,startPoint:r.A.fromDegrees(p.startLng,p.startLat,p.startHeight),endPoint:r.A.fromDegrees(p.endLng,p.endLat,p.endHeight)}),console.log("\u901A\u89C6\u5206\u6790\u5DF2\u521B\u5EFA")},\u6267\u884C\u5206\u6790:()=>{if(!y){m.oR.warning("\u8BF7\u5148\u521B\u5EFA\u5206\u6790"),console.warn("\u8BF7\u5148\u521B\u5EFA\u5206\u6790");return}let e=y.analyze();if(p.visible=e.visible,p.visibleDistance=Number.parseFloat(e.visibleDistance.toFixed(2)),p.totalDistance=Number.parseFloat(e.totalDistance.toFixed(2)),m.oR.info(`\u{901A}\u{89C6}\u{5206}\u{6790}\u{7ED3}\u{679C}: ${e.visible?"\u53EF\u89C1":"\u4E0D\u53EF\u89C1"}`),console.log(`\u{901A}\u{89C6}\u{5206}\u{6790}\u{7ED3}\u{679C}: ${e.visible?"\u53EF\u89C1":"\u4E0D\u53EF\u89C1"}`),console.log(`\u{53EF}\u{89C1}\u{8DDD}\u{79BB}: ${p.visibleDistance}m`),console.log(`\u{603B}\u{8DDD}\u{79BB}: ${p.totalDistance}m`),!e.visible){let t=h.A.fromCartesian(e.barrierPoint);console.log(`\u{969C}\u{788D}\u{70B9}\u{5750}\u{6807}: lng=${d.A.toDegrees(t.longitude)}, lat=${d.A.toDegrees(t.latitude)}, height=${t.height}`)}},\u6E05\u9664:()=>{y&&(y.clear(),y=null),p.visible=!1,p.visibleDistance=0,p.totalDistance=0,console.log("\u5DF2\u6E05\u9664\u5206\u6790")}},b=g.addFolder("\u89C2\u6D4B\u70B9\u8BBE\u7F6E");b.add(p,"startLng",-180,180,1e-6).name("\u7ECF\u5EA6").listen(),b.add(p,"startLat",-90,90,1e-6).name("\u7EAC\u5EA6").listen(),b.add(p,"startHeight",0,1e4,10).name("\u9AD8\u5EA6 (\u7C73)").listen(),b.open();let w=g.addFolder("\u76EE\u7684\u70B9\u8BBE\u7F6E");w.add(p,"endLng",-180,180,1e-6).name("\u7ECF\u5EA6").listen(),w.add(p,"endLat",-90,90,1e-6).name("\u7EAC\u5EA6").listen(),w.add(p,"endHeight",0,1e4,10).name("\u9AD8\u5EA6 (\u7C73)").listen(),w.open();let A=g.addFolder("\u5206\u6790\u7ED3\u679C");A.add(p,"visible").name("\u662F\u5426\u53EF\u89C1").listen(),A.add(p,"visibleDistance").name("\u53EF\u89C1\u8DDD\u79BB (\u7C73)").listen(),A.add(p,"totalDistance").name("\u603B\u8DDD\u79BB (\u7C73)").listen(),A.open();let E=g.addFolder("\u64CD\u4F5C");E.add(p,"\u521B\u5EFA\u5206\u6790"),E.add(p,"\u6267\u884C\u5206\u6790"),E.add(p,"\u6E05\u9664"),E.open();let C=null,f=new c.A(t.scene.canvas);return f.setInputAction(e=>{if(!C)return;let i=t.camera.pickEllipsoid(e.position,t.scene.globe.ellipsoid);if(!i)return;let n=h.A.fromCartesian(i),s=d.A.toDegrees(n.longitude),a=d.A.toDegrees(n.latitude);"start"===C?(p.startLng=s,p.startLat=a,console.log(`\u{89C2}\u{6D4B}\u{70B9}\u{5750}\u{6807}\u{5DF2}\u{66F4}\u{65B0}: lng=${s}, lat=${a}`)):"end"===C&&(p.endLng=s,p.endLat=a,console.log(`\u{76EE}\u{7684}\u{70B9}\u{5750}\u{6807}\u{5DF2}\u{66F4}\u{65B0}: lng=${s}, lat=${a}`)),C=null},o.A.LEFT_CLICK),console.log("\u63D0\u793A\uFF1A\u53EF\u4EE5\u901A\u8FC7GUI\u9762\u677F\u8BBE\u7F6E\u89C2\u6D4B\u70B9\u548C\u76EE\u7684\u70B9\u5750\u6807"),{viewer:t,gui:g,cleanup:()=>{y&&y.clear(),f.destroy()}}}}}]);