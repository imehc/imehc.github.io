import{a as e}from"./chunk-DAX2P4DI.js";import{c as t}from"./chunk-BNHFHP3L.js";import{j as i}from"./chunk-4NDD6KRQ.js";import{b as o}from"./chunk-5ELDAYCN.js";import{a as r}from"./chunk-N6BI774S.js";import{a as n,b as a,c as s}from"./chunk-ICY67TC6.js";import{a as c}from"./chunk-G2EMNOST.js";import{a as l}from"./chunk-4VFKVGYI.js";import{a as u,b as m}from"./chunk-3WJNS2B6.js";import{e as f}from"./chunk-XCN226AA.js";function d(e,t){m.typeOf.object("ellipsoid",e),this._ellipsoid=e,this._cameraPosition=new c,this._cameraPositionInScaledSpace=new c,this._distanceToLimbInScaledSpaceSquared=0,f(t)&&(this.cameraPosition=t)}Object.defineProperties(d.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){let t=this._ellipsoid.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),i=c.magnitudeSquared(t)-1;c.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=t,this._distanceToLimbInScaledSpaceSquared=i}}});var h=new c;d.prototype.isPointVisible=function(e){return T(this._ellipsoid.transformPositionToScaledSpace(e,h),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},d.prototype.isScaledSpacePointVisible=function(e){return T(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};var p=new c;d.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){let i=this._ellipsoid,o,r;return f(t)&&t<0&&i.minimumRadius>-t?((r=p).x=this._cameraPosition.x/(i.radii.x+t),r.y=this._cameraPosition.y/(i.radii.y+t),r.z=this._cameraPosition.z/(i.radii.z+t),o=r.x*r.x+r.y*r.y+r.z*r.z-1):(r=this._cameraPositionInScaledSpace,o=this._distanceToLimbInScaledSpaceSquared),T(e,r,o)},d.prototype.computeHorizonCullingPoint=function(e,t,i){return g(this._ellipsoid,e,t,i)};var y=s.clone(s.UNIT_SPHERE);d.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,o){return g(b(this._ellipsoid,i,y),e,t,o)},d.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,o,r){return O(this._ellipsoid,e,t,i,o,r)},d.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,o,r,n){return O(b(this._ellipsoid,r,y),e,t,i,o,n)};var S=[];d.prototype.computeHorizonCullingPointFromRectangle=function(e,o,r){m.typeOf.object("rectangle",e);let n=i.subsample(e,o,0,S),a=t.fromPoints(n);if(!(c.magnitude(a.center)<.1*o.minimumRadius))return this.computeHorizonCullingPoint(a.center,n,r)};var x=new c;function b(e,t,i){if(f(t)&&t<0&&e.minimumRadius>-t){let o=c.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,x);e=s.fromCartesian3(o,i)}return e}function g(e,t,i,o){m.typeOf.object("directionToPoint",t),m.defined("positions",i),f(o)||(o=new c);let r=H(e,t),n=0;for(let t=0,o=i.length;t<o;++t){let o=_(e,i[t],r);if(o<0)return;n=Math.max(n,o)}return j(r,n,o)}var N=new c;function O(e,t,i,o,r,n){m.typeOf.object("directionToPoint",t),m.defined("vertices",i),m.typeOf.number("stride",o),f(n)||(n=new c),o=o??3,r=r??c.ZERO;let a=H(e,t),s=0;for(let t=0,n=i.length;t<n;t+=o){N.x=i[t]+r.x,N.y=i[t+1]+r.y,N.z=i[t+2]+r.z;let o=_(e,N,a);if(o<0)return;s=Math.max(s,o)}return j(a,s,n)}function T(e,t,i){let o=c.subtract(e,t,h),r=-c.dot(o,t);return!(i<0?r>0:r>i&&r*r/c.magnitudeSquared(o)>i)}var P=new c,z=new c;function _(e,t,i){let o=e.transformPositionToScaledSpace(t,P),r=c.magnitudeSquared(o),n=Math.sqrt(r),a=c.divideByScalar(o,n,z);r=Math.max(1,r),n=Math.max(1,n);let s=c.dot(a,i),l=c.magnitude(c.cross(a,i,a)),u=1/n,m=Math.sqrt(r-1)*u;return 1/(s*u-l*m)}function j(e,t,i){if(!(t<=0||t===1/0||t!=t))return c.multiplyByScalar(e,t,i)}var E=new c;function H(e,t){return c.equals(t,c.ZERO)?t:(e.transformPositionToScaledSpace(t,E),c.normalize(E,E))}var w=d,I={};I.getHeight=function(e,t,i){if(!Number.isFinite(t))throw new u("scale must be a finite number.");if(!Number.isFinite(i))throw new u("relativeHeight must be a finite number.");return(e-i)*t+i};var v=new n;I.getPosition=function(e,t,i,o,r){let n=t.cartesianToCartographic(e,v);if(!f(n))return c.clone(e,r);let a=I.getHeight(n.height,i,o);return c.fromRadians(n.longitude,n.latitude,a,t,r)};var B=I,C=Object.freeze({NONE:0,BITS12:1}),q=new c,G=new c,M=new a,V=new o,A=new o;function R(e,t,i,r,n,a,s,l,u,m){let d=C.NONE,h,p;if(f(t)&&f(i)&&f(r)&&f(n)){let a=t.minimum,s=t.maximum,l=c.subtract(s,a,G),u=r-i;d=4095>Math.max(c.maximumComponent(l),u)?C.BITS12:C.NONE;let m=o.fromScale(l,V);m=o.setTranslation(m,a,m);let f=o.fromScale(c.fromElements(1/l.x,1/l.y,1/l.z,q),A);f=o.multiplyByTranslation(f,c.negate(a,q),f),p=o.clone(n,new o);let y=o.getTranslation(n,q);y=c.subtract(y,e,q),p=o.setTranslation(p,y,p),p=o.multiply(p,m,p),h=o.inverseTransformation(n,new o),h=o.multiply(f,h,h),n=o.multiply(n,m,new o)}this.quantization=d,this.minimumHeight=i,this.maximumHeight=r,this.center=c.clone(e),this.toScaledENU=h,this.fromScaledENU=n,this.matrix=p,this.hasVertexNormals=a??!1,this.hasWebMercatorT=s??!1,this.hasGeodeticSurfaceNormals=l??!1,this.exaggeration=u??1,this.exaggerationRelativeHeight=m??0,this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}R.prototype.encode=function(t,i,r,n,s,c,u,f){m.typeOf.object("vertexBuffer",t),m.typeOf.number("bufferIndex",i),m.typeOf.object("position",r),m.typeOf.object("uv",n),m.typeOf.number("height",s);let d=n.x,h=n.y;if(this.quantization===C.BITS12){(r=o.multiplyByPoint(this.toScaledENU,r,q)).x=l.clamp(r.x,0,1),r.y=l.clamp(r.y,0,1),r.z=l.clamp(r.z,0,1);let n=this.maximumHeight-this.minimumHeight,c=l.clamp((s-this.minimumHeight)/n,0,1);a.fromElements(r.x,r.y,M);let m=e.compressTextureCoordinates(M);a.fromElements(r.z,c,M);let f=e.compressTextureCoordinates(M);a.fromElements(d,h,M);let p=e.compressTextureCoordinates(M);if(t[i++]=m,t[i++]=f,t[i++]=p,this.hasWebMercatorT){a.fromElements(u,0,M);let o=e.compressTextureCoordinates(M);t[i++]=o}}else t[i++]=r.x-this.center.x,t[i++]=r.y-this.center.y,t[i++]=r.z-this.center.z,t[i++]=s,t[i++]=d,t[i++]=h,this.hasWebMercatorT&&(t[i++]=u);return this.hasVertexNormals&&(t[i++]=e.octPackFloat(c)),this.hasGeodeticSurfaceNormals&&(t[i++]=f.x,t[i++]=f.y,t[i++]=f.z),i};var U=new c,k=new c;R.prototype.addGeodeticSurfaceNormals=function(e,t,i){if(m.typeOf.object("oldBuffer",e),m.typeOf.object("newBuffer",t),m.typeOf.object("ellipsoid",i),this.hasGeodeticSurfaceNormals)return;let o=this.stride,r=e.length/o;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();let n=this.stride;for(let a=0;a<r;a++){for(let i=0;i<o;i++){let r=a*o+i;t[a*n+i]=e[r]}let r=this.decodePosition(t,a,U),s=i.geodeticSurfaceNormal(r,k),c=a*n+this._offsetGeodeticSurfaceNormal;t[c]=s.x,t[c+1]=s.y,t[c+2]=s.z}},R.prototype.removeGeodeticSurfaceNormals=function(e,t){if(m.typeOf.object("oldBuffer",e),m.typeOf.object("newBuffer",t),!this.hasGeodeticSurfaceNormals)return;let i=this.stride,o=e.length/i;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();let r=this.stride;for(let n=0;n<o;n++)for(let o=0;o<r;o++){let a=n*i+o;t[n*r+o]=e[a]}},R.prototype.decodePosition=function(t,i,r){if(m.typeOf.object("buffer",t),m.typeOf.number("index",i),f(r)||(r=new c),i*=this.stride,this.quantization===C.BITS12){let n=e.decompressTextureCoordinates(t[i],M);r.x=n.x,r.y=n.y;let a=e.decompressTextureCoordinates(t[i+1],M);return r.z=a.x,o.multiplyByPoint(this.fromScaledENU,r,r)}return r.x=t[i],r.y=t[i+1],r.z=t[i+2],c.add(r,this.center,r)},R.prototype.getExaggeratedPosition=function(e,t,i){i=this.decodePosition(e,t,i);let o=this.exaggeration,r=this.exaggerationRelativeHeight;if(1!==o&&this.hasGeodeticSurfaceNormals){let n=this.decodeGeodeticSurfaceNormal(e,t,k),a=this.decodeHeight(e,t),s=B.getHeight(a,o,r)-a;i.x+=n.x*s,i.y+=n.y*s,i.z+=n.z*s}return i},R.prototype.decodeTextureCoordinates=function(t,i,o){return m.typeOf.object("buffer",t),m.typeOf.number("index",i),f(o)||(o=new a),i*=this.stride,this.quantization===C.BITS12?e.decompressTextureCoordinates(t[i+2],o):a.fromElements(t[i+4],t[i+5],o)},R.prototype.decodeHeight=function(t,i){return m.typeOf.object("buffer",t),m.typeOf.number("index",i),i*=this.stride,this.quantization===C.BITS12?e.decompressTextureCoordinates(t[i+1],M).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:t[i+3]},R.prototype.decodeWebMercatorT=function(t,i){return m.typeOf.object("buffer",t),m.typeOf.number("index",i),i*=this.stride,this.quantization===C.BITS12?e.decompressTextureCoordinates(t[i+3],M).x:t[i+6]},R.prototype.getOctEncodedNormal=function(e,t,i){m.typeOf.object("buffer",e),m.typeOf.number("index",t);let o=e[t=t*this.stride+this._offsetVertexNormal]/256,r=Math.floor(o);return a.fromElements(r,(o-r)*256,i)},R.prototype.decodeNormal=function(t,i,o){m.typeOf.object("buffer",t),m.typeOf.number("index",i),m.typeOf.object("result",o);let r=i=i*this.stride+this._offsetVertexNormal;return e.octDecodeFloat(t[r],o)},R.prototype.decodeGeodeticSurfaceNormal=function(e,t,i){return m.typeOf.object("buffer",e),m.typeOf.number("index",t),m.typeOf.object("result",i),i.x=e[t=t*this.stride+this._offsetGeodeticSurfaceNormal],i.y=e[t+1],i.z=e[t+2],i},R.prototype._calculateStrideAndOffsets=function(){let e=0;this.quantization===C.BITS12?e+=3:e+=6,this.hasWebMercatorT&&(e+=1),this.hasVertexNormals&&(this._offsetVertexNormal=e,e+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=e,e+=3),this.stride=e};var W={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},F={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};R.prototype.getAttributes=function(e){m.typeOf.object("buffer",e);let t=r.FLOAT,i=r.getSizeInBytes(t),o=this.stride*i,n=0,a=[];function s(r,s){a.push({index:r,vertexBuffer:e,componentDatatype:t,componentsPerAttribute:s,offsetInBytes:n,strideInBytes:o}),n+=s*i}if(this.quantization===C.NONE){let e;s(W.position3DAndHeight,4),e=2+(+!!this.hasWebMercatorT+ +!!this.hasVertexNormals),s(W.textureCoordAndEncodedNormals,e),this.hasGeodeticSurfaceNormals&&s(W.geodeticSurfaceNormal,3)}else{let e=this.hasWebMercatorT||this.hasVertexNormals,t=this.hasWebMercatorT&&this.hasVertexNormals;s(F.compressed0,e?4:3),t&&s(F.compressed1,1),this.hasGeodeticSurfaceNormals&&s(F.geodeticSurfaceNormal,3)}return a},R.prototype.getAttributeLocations=function(){return this.quantization===C.NONE?W:F},R.clone=function(e,t){if(f(e))return f(t)||(t=new R),t.quantization=e.quantization,t.minimumHeight=e.minimumHeight,t.maximumHeight=e.maximumHeight,t.center=c.clone(e.center),t.toScaledENU=o.clone(e.toScaledENU),t.fromScaledENU=o.clone(e.fromScaledENU),t.matrix=o.clone(e.matrix),t.hasVertexNormals=e.hasVertexNormals,t.hasWebMercatorT=e.hasWebMercatorT,t.hasGeodeticSurfaceNormals=e.hasGeodeticSurfaceNormals,t.exaggeration=e.exaggeration,t.exaggerationRelativeHeight=e.exaggerationRelativeHeight,t._calculateStrideAndOffsets(),t};var D=R;export{w as a,B as b,D as c};