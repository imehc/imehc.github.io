import{a as e}from"./chunk-ITDFUUP5.js";import{a as t}from"./chunk-DAX2P4DI.js";import{a as r}from"./chunk-KSX6TRAS.js";import{c as s,j as a}from"./chunk-4NDD6KRQ.js";import"./chunk-5ELDAYCN.js";import"./chunk-N6BI774S.js";import"./chunk-TI35VBH7.js";import"./chunk-6WLI3422.js";import{a as n,c as i}from"./chunk-ICY67TC6.js";import{a as o}from"./chunk-G2EMNOST.js";import{a as l}from"./chunk-4VFKVGYI.js";import"./chunk-3WJNS2B6.js";import"./chunk-XCN226AA.js";var d=Math.cos(l.toRadians(150)),f=new n,c=new o,h=new n,u=new n;function p(e){let t=8*e,s=3*t,a=4*t;this.startEllipsoidNormals=new Float32Array(s),this.endEllipsoidNormals=new Float32Array(s),this.startPositionAndHeights=new Float32Array(a),this.startFaceNormalAndVertexCornerIds=new Float32Array(a),this.endPositionAndHeights=new Float32Array(a),this.endFaceNormalAndHalfWidths=new Float32Array(a),this.vertexBatchIds=new Uint16Array(t),this.indices=r.createTypedArray(t,36*e),this.vec3Offset=0,this.vec4Offset=0,this.batchIdOffset=0,this.indexOffset=0,this.volumeStartIndex=0}var m=new o,A=new o;function w(e,t,r,s,a){let n=o.subtract(r,t,A),i=o.subtract(t,e,m);return o.normalize(n,n),o.normalize(i,i),o.dot(n,i)<d&&(i=o.multiplyByScalar(i,-1,m)),o.add(n,i,a),o.equals(a,o.ZERO)&&(a=o.subtract(e,t)),o.cross(a,s,a),o.cross(s,a,a),o.normalize(a,a),a}var k=[0,2,6,0,6,4,0,1,3,0,3,2,0,4,5,0,5,1,5,3,1,5,7,3,7,5,4,7,4,6,7,6,2,7,2,3],N=k.length,b=new o,g=new o,I=new o,y=new o,F=new o;p.prototype.addVolume=function(e,t,r,s,a,n,i,l,d,f){let c=o.add(t,d,b),h=f.geodeticSurfaceNormal(c,g);c=o.add(r,d,b);let u=f.geodeticSurfaceNormal(c,y),p=w(e,t,r,h,I),m=w(s,r,t,u,F),A=this.startEllipsoidNormals,E=this.endEllipsoidNormals,x=this.startPositionAndHeights,v=this.startFaceNormalAndVertexCornerIds,H=this.endPositionAndHeights,O=this.endFaceNormalAndHalfWidths,P=this.vertexBatchIds,S=this.batchIdOffset,j=this.vec3Offset,D=this.vec4Offset,B;for(B=0;B<8;B++)o.pack(h,A,j),o.pack(u,E,j),o.pack(t,x,D),x[D+3]=a,o.pack(r,H,D),H[D+3]=n,o.pack(p,v,D),v[D+3]=B,o.pack(m,O,D),O[D+3]=i,P[S++]=l,j+=3,D+=4;this.batchIdOffset=S,this.vec3Offset=j,this.vec4Offset=D;let T=this.indices,U=this.volumeStartIndex,V=this.indexOffset;for(B=0;B<N;B++)T[V+B]=k[B]+U;this.volumeStartIndex+=8,this.indexOffset+=N};var E=new a,x=new i,v=new o,H=new o,O=new o,P=new o,S=new o,j=e(function(e,d){let m=new Uint16Array(e.positions),A=new Uint16Array(e.widths),w=new Uint32Array(e.counts),k=new Uint16Array(e.batchIds),N=new Float64Array(e.packedBuffer),b=0,g=N[b++],I=N[b++];a.unpack(N,b,E),b+=a.packedLength,i.unpack(N,b,x),b+=i.packedLength,o.unpack(N,b,v);let y,F=m.length/3,j=m.subarray(0,F),D=m.subarray(F,2*F),B=m.subarray(2*F,3*F);t.zigZagDeltaDecode(j,D,B),function(e,t,r,s){let a=s.length,i=e.length,o=new Uint8Array(i),l=0;for(let r=0;r<a;r++){let a=s[r],i=a;for(let r=1;r<a;r++){let s=l+r,a=s-1;u.longitude=e[s],u.latitude=t[s],h.longitude=e[a],h.latitude=t[a],n.equals(u,h)&&(i--,o[a]=1)}s[r]=i,l+=a}let d=0;for(let s=0;s<i;s++)1!==o[s]&&(e[d]=e[s],t[d]=t[s],r[d]=r[s],d++)}(j,D,B,w);let T=w.length,U=0;for(y=0;y<T;y++)U+=w[y]-1;let V=new p(U),C=function(e,t,r,s,a,i,d){let h=e.length,u=new Float64Array(3*h);for(let p=0;p<h;++p){let h=e[p],m=t[p],A=r[p],w=l.lerp(s.west,s.east,h/32767),k=l.lerp(s.south,s.north,m/32767),N=l.lerp(a,i,A/32767),b=n.fromRadians(w,k,N,f),g=d.cartographicToCartesian(b,c);o.pack(g,u,3*p)}return u}(j,D,B,E,g,I,x,v),R=new Float32Array(3*(F=j.length));for(y=0;y<F;++y)R[3*y]=C[3*y]-v.x,R[3*y+1]=C[3*y+1]-v.y,R[3*y+2]=C[3*y+2]-v.z;let W=0,z=0;for(y=0;y<T;y++){let e=w[y]-1,t=.5*A[y],r=k[y],s=W;for(let a=0;a<e;a++){let n=o.unpack(R,W,O),i=o.unpack(R,W+3,P),d=B[z],f=B[z+1];d=l.lerp(g,I,d/32767),f=l.lerp(g,I,f/32767),z++;let c=H,h=S;if(0===a){let t=s+3*e,r=o.unpack(R,t,H);if(o.equals(r,n))o.unpack(R,t-3,c);else{let e=o.subtract(n,i,H);c=o.add(e,n,H)}}else o.unpack(R,W-3,c);if(a===e-1){let e=o.unpack(R,s,S);if(o.equals(e,i))o.unpack(R,s+3,h);else{let e=o.subtract(i,n,S);h=o.add(e,i,S)}}else o.unpack(R,W+6,h);V.addVolume(c,n,i,h,d,f,t,r,v,x),W+=3}W+=3,z++}let L=V.indices;d.push(V.startEllipsoidNormals.buffer),d.push(V.endEllipsoidNormals.buffer),d.push(V.startPositionAndHeights.buffer),d.push(V.startFaceNormalAndVertexCornerIds.buffer),d.push(V.endPositionAndHeights.buffer),d.push(V.endFaceNormalAndHalfWidths.buffer),d.push(V.vertexBatchIds.buffer),d.push(L.buffer);let q={indexDatatype:2===L.BYTES_PER_ELEMENT?r.UNSIGNED_SHORT:r.UNSIGNED_INT,startEllipsoidNormals:V.startEllipsoidNormals.buffer,endEllipsoidNormals:V.endEllipsoidNormals.buffer,startPositionAndHeights:V.startPositionAndHeights.buffer,startFaceNormalAndVertexCornerIds:V.startFaceNormalAndVertexCornerIds.buffer,endPositionAndHeights:V.endPositionAndHeights.buffer,endFaceNormalAndHalfWidths:V.endFaceNormalAndHalfWidths.buffer,vertexBatchIds:V.vertexBatchIds.buffer,indices:L.buffer};if(e.keepDecodedPositions){let e=function(e){let t=e.length,r=new Uint32Array(t+1),s=0;for(let a=0;a<t;++a)r[a]=s,s+=e[a];return r[t]=s,r}(w);d.push(C.buffer,e.buffer),q=s(q,{decodedPositions:C.buffer,decodedPositionOffsets:e.buffer})}return q});export{j as default};